#!/usr/bin/env bash

set -e

diff=
record=

help () {
  echo "Usage: $(dirname $0) [-h] [--diff] [--record]"
}

while [ -n "$1" ] ; do
  case "$1" in
    -h|--help)
      help
      exit
      ;;
    --diff)
      diff="1"
      shift
      ;;
    --record)
      record=1
      shift
      ;;
    *)
      help
      exit 2
  esac
done


bin="$(dirname $BASH_SOURCE)"
record_filename="$(dirname $bin)/server/schema.sql"


eval "$($bin/pg_vars)"

dump () {
  pg_dump --schema-only | grep -Ev '^(--|GRANT|REVOKE|SET|ALTER TABLE.*OWNER|COMMENT|CREATE EXTENSION)' | grep -v '^$'
}

if [ -n "$diff" ] ; then
  tmpfile="/tmp/schema-$(date +%Y%m%dT%H%M%S).sql"
  dump > $tmpfile
  diff -u $tmpfile $record_filename
  rm $tmpfile
elif [ -n "$record" ] ; then
  echo "Saving to $record_filename"
  dump > $record_filename
else
  dump
fi
