#!/bin/bash

set -e
cd "$(dirname ${BASH_SOURCE[0]})/.."
base="$(pwd)"
PATH="node_modules/.bin:$PATH"
webext="$base/node_modules/.bin/web-ext"
nodemon_pid=

binary=
firefoxes="
/Applications/FirefoxNightly.app
/Applications/FirefoxDeveloperEdition.app
/Applications/FirefoxAurora.app
"

for firefox in $firefoxes ; do
  if [[ -e "$firefox" ]] ; then
    binary="$firefox"
    break
  fi
done

_cleanup () {
  if [[ -n "$nodemon_pid" ]] ; then
    # Seems to usually be dead by this point?  Good I guess?
    echo "trying to kill $nodemon_pid"
    kill $nodemon_pid >& /dev/null || true
  fi
}

trap _cleanup EXIT

help () {
  echo "Usage: $(basename $0) [OPTIONS]"
  echo "  Options:"
  echo "    --no-auto"
  echo "      Do not watch for changes in the addon"
  echo "    -b or --binary BINARY"
  echo "      Use BINARY as the Firefox to run (default $binary)"
  echo "    --scratch"
  echo "      Use a scratch profile"
  #echo "    -s or --server URL"
  #echo "      Use the given server (default localhost:10080)"
}


while [[ -n "$1" ]] ; do
  case "$1" in
    help|-h|--help)
      help
      exit
      ;;
    -b|--binary)
      binary="$2"
      shift
      shift
      ;;
    --scratch)
      scratch=1
      shift
      ;;
    #--server|-s)
    #  server="$2"
    #  shift
    #  shift
    #  ;;
    *)
      help
      exit 2
      ;;
  esac
done

profile_option=
if [[ -z "$scratch" ]] ; then
  mkdir -p ./Profile
  profile_option="--firefox-profile ./Profile/"
fi

make addon
nodemon \
  -w shared/shot.js \
  -w Makefile \
  --on-change-only \
  --exec make addon &
nodemon_pid=$!
echo "nodemon started in $nodemon_pid"

$webext run --firefox "$binary" $profile_option --source-dir ./webextension/
